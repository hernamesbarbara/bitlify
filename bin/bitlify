#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""bitlify

Usage:
  bitlify (URL | -C CSV [-T TITLE] [-B BACKHALF]) [-O OUTFILE]
  bitlify -h | --help

Arguments:
    URL                             URL to be shortened.

Options:
  -h --help                       Show this screen.
  -T TITLE --title TITLE          Title associated with the URL [default: ].
  -B BACKHALF --backhalf BACKHALF Desired custom back-half for the short URL [default: ].
  -C CSV --csv CSV                CSV file containing URLs to be shortened.
  -O OUTFILE --outfile OUTFILE    Output file name [default: output.csv].

"""
import sys
import os
import pandas as pd
from docopt import docopt
import bitlyutils as utils

# Reading Bitly access token from the file
with open(os.path.expanduser('~/.bitly'), 'r') as f:
    ACCESS_TOKEN = f.read().strip()

__version__ = '0.1.0'
__author__ = "austin"
__license__ = "MIT"

def main(args):
    if args.get('--csv'):
        df = pd.read_csv(args['--csv'])
        df.columns = [col.lower() for col in df.columns]

        results = utils.process_url_list(df.to_dict(orient='records'), ACCESS_TOKEN)
            
        df_out = pd.DataFrame(results)
        if args.get('--outfile'):
            outfile = args['--outfile']
        else:
            outfile = 'output.csv'
        df_out.to_csv(outfile, index=False, encoding='utf-8')
        sys.stdout.write(f"saved {len(df_out)} results to {outfile}")
        sys.exit(0)
    else:
        url = args['URL']
        title = args.get('--title')
        backhalf = args.get('--backhalf')
        result = utils.process_single_url(url, ACCESS_TOKEN, title, backhalf)
        sys.stdout.write(f"{result['short_url']}")
        sys.exit(0)

if __name__ == "__main__":
    arguments = docopt(__doc__)
    main(arguments)
